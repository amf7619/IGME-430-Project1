<!DOCTYPE html>
<html lang="en">

<head>
    <title>Our simple HTTP server</title>
    <link rel="stylesheet" type="text/css" href="/style.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
    <script type="text/babel">
    
        const boardWidth = 5;
        const boardHeight = 5;

        let boardButtons;
        let colorPicker;
        let currentBoardName;
        
        const parseJSON = (xhr, content) => {
            if (xhr.response && xhr.getResponseHeader('Content-Type') == 'application/json') {
                const obj = JSON.parse(xhr.response);

                if(obj.message) {
                    content.innerHTML += `<p>Message: ${obj.message}</p>`;
                }
                else {
                    content.innerHTML += `<p>${xhr.response}</p>`;
                }

                if(obj.board) {
                    drawBoard(obj.board);
                }
                else if(obj.names) {
                    boardListButtons(obj.names);
                }
            }

            document.querySelector("#boardName").innerHTML = currentBoardName;
        }

        const drawBoard = (board) => {
            document.querySelector("#list").innerHTML = '';

            currentBoardName = board.name;

            for(let i = 0; i < boardHeight; i++) {
                for(let j = 0; j < boardWidth; j++)
                {
                    boardButtons[(i * boardWidth) + j].value = board.board[i][j];
                    boardButtons[(i * boardWidth) + j].style.backgroundColor = board.board[i][j];
                }
            }
        }

        const boardListButtons = (names) => {
            let list = document.querySelector("#list");

            list.innerHTML = '';

            for(let i = 0; i < names.length; i++)
            {
                let newForm = document.createElement('form');
                newForm.setAttribute('action', '/getBoard');
                newForm.setAttribute('method', 'get');
                let newInput = document.createElement('input');
                newInput.setAttribute('type', 'submit');
                newInput.setAttribute('value', names[i]);
                newInput.setAttribute('class', 'boardListButton')
                newForm.appendChild(newInput);

                let findBoard = (e) => requestUpdate(e, newForm, names[i]);
                newForm.addEventListener('submit', findBoard);

                list.appendChild(newForm);
            }
            
        }

        const handleResponse = (xhr, parseResponse) => {
            const content = document.querySelector('#content');

            switch (xhr.status) {
                case 200:
                    content.innerHTML = '<b>Success!</b>';
                    break;
                case 201:
                    content.innerHTML = '<b>Created!</b>';
                    createNewBoard();
                    break;
                case 204:
                    content.innerHTML = '<b>Updated (No Content)</b>';
                    break;
                case 400:
                    content.innerHTML = '<b>Bad Request</b>';
                    break;
                case 404:
                    content.innerHTML = '<b>Resource Not Found</b>';
                    break;
                default:
                    content.innerHTML = '<p>Error code not implemented by client!</p>'
                    break;
            }

            parseJSON(xhr, content);
        }

        const createXMLRequest = (form, query) => {
            let url = form.getAttribute('action');
            if(query !== undefined) url += `?${query}`;

            const method = form.getAttribute('method');

            const xhr = new XMLHttpRequest();
            xhr.open(method, url);

            return xhr;
        }

        const sendPost = (e, form, row, col) => {
            e.preventDefault();

            const xhr = createXMLRequest(form);

            xhr.setRequestHeader('Accept', 'application/json');
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

            xhr.onload = () => handleResponse(xhr);

            let formData = `name=${currentBoardName}`;
            if(row !== undefined && col !== undefined) {
                formData += `&row=${row}&col=${col}&color=${form.value}`;
            }
            xhr.send(formData);

            return false;
        };

        const requestUpdate = (e, form, optionalName) => {
            e.preventDefault();

            const xhr = createXMLRequest(form, 'name='+optionalName);

            xhr.setRequestHeader('Accept', 'application/json');

            if (form.getAttribute('method') === 'get') {
                xhr.onload = () => handleResponse(xhr, true);
            } else {
                xhr.onload = () => handleResponse(xhr, false);
            }

            xhr.send();

            return false;
        };

        const pressBoardButton = (e, row, col) => {
            let buttonPressed = boardButtons[(row * boardWidth) + col];
            buttonPressed.style.backgroundColor = colorPicker.value;
            buttonPressed.value = colorPicker.value;

            sendPost(e, buttonPressed, row, col);
        };

        const createNewBoard = () => {

            let boardCol = document.querySelector("#boardCol");
            boardCol.innerHTML = '';

            for(let i = 0; i < boardHeight; i++)
            {
                let boardRow = document.createElement("div");
                boardRow.setAttribute('id', 'boardRow');

                for(let j = 0; j < boardWidth; j++)
                {
                    let newButton = document.createElement("button");
                    newButton.setAttribute('class', 'boardButton');
                    newButton.setAttribute('value', '#ffffff');
                    newButton.setAttribute('action', '/updateBoard');
                    newButton.setAttribute('method', 'post');

                    let buttonEvent = (e) => pressBoardButton(e, i, j);

                    newButton.addEventListener('click', buttonEvent);
                    boardRow.appendChild(newButton);
                }
                boardCol.appendChild(boardRow);
            }
        };

        const init = () => {
            const boardForm = document.querySelector('#boardForm');
            const nameForm = document.querySelector('#nameForm');
            colorPicker = document.querySelector('#colorPicker');

            boardButtons = document.getElementsByClassName("boardButton");

            const getBoards = (e) => requestUpdate(e, boardForm);
            const addUser = (e) => { currentBoardName = nameForm.querySelector("#nameField").value; sendPost(e, nameForm);}

            boardForm.addEventListener('submit', getBoards);
            nameForm.addEventListener('submit', addUser);
        };

        window.onload = init;
    </script>
</head>

<body>
    <section id="top">
        <h3>Color Chart</h3>
        <form id="nameForm" action="/addBoard" method="post">
            <input id="nameField" type="text" name="name" placeholder="Board Name"/>
            <input type="submit" value="Create New Board"/>
        </form>
        <form id="boardForm" action="/getBoardList" method="get">
            <input type="submit" value="Get All Boards"/>
        </form>
    </section>
    <section id="content">
    </section>
    <section id="list">

    </section>
    <section id="board">
        <h3 id="boardName"></h3>
        <select id="colorPicker">
            <option value="#ffffff">White</option>
            <option value="#ff0000" selected>Red</option>
            <option value="#ff9933">Orange</option>
            <option value="#ffff00">Yellow</option>
            <option value="#00ff00">Green</option>
            <option value="#00ffff">Cyan</option>
            <option value="#0000ff">Blue</option>
            <option value="#ff00ff">Purple</option>
            <option value="#ffffff">Black</option>
        </select>
        <div id="boardCol">
        </div>
    </section>
</body>

</html>